<!DOCTYPE html>
<html>
<head>
    <title>Xenosis Basic Test</title>
</head>
<body>

<h2>Xenosis Basic Test</h2>

<label>Masukkan text:</label><br>
<input type="text" id="text" value="Hello XENO"><br><br>

<button onclick="start()">Start Proof</button>

<pre id="log"></pre>

<script>
async function sha256(msg) {
    const buffer = new TextEncoder().encode(msg);
    const digest = await crypto.subtle.digest("SHA-256", buffer);
    return Array.from(new Uint8Array(digest))
        .map(b => b.toString(16).padStart(2, "0")).join("");
}

async function start() {
    const log = (msg) => document.getElementById("log").textContent += msg + "\n";

    const text = document.getElementById("text").value;

    // ====== 1. Minta salt dari backend ======
    const res = await fetch("http://113.23.151.122:8080/backend.php?action=challenge");
    const { salt, target } = await res.json();
    log("Salt: " + salt);
    log("Target: " + target);

    // ====== 2. Mining Nonce ======
    let nonce = 0;
    while (true) {
        const hash = await sha256(text + salt + nonce);
        if (hash.startsWith(target)) {
            log("Hash found: " + hash);
            log("Nonce: " + nonce);

            // ====== 3. Submit ke backend ======
            const verify = await fetch(
                "http://113.23.151.122:8080/backend.php?action=verify",
                {
                    method: "POST",
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    body: `text=${text}&salt=${salt}&nonce=${nonce}&target=${target}`
                }
            );

            const result = await verify.json();
            log("Server verify: " + JSON.stringify(result));
            return;
        }
        nonce++;
    }
}
</script>

</body>
</html>
